{% extends "base_admin.html" %}
{% block title %}إدارة الموظفين{% endblock %}
{% block page_title %}إدارة الموظفين{% endblock %}

{% block action_bar %}
<button class="btn btn-sm btn-primary" onclick="showAddEmployeeModal()">
  <i class="fas fa-plus"></i> إضافة موظف
</button>
<button class="btn btn-sm btn-success" onclick="openDepartmentsModal()">
  <i class="fas fa-building"></i> إدارة الأقسام
</button>
<button class="btn btn-sm btn-secondary" onclick="toggleImportSection()">
  <i class="fas fa-file-import"></i> استيراد Excel
</button>
<button class="btn btn-sm btn-info" onclick="exportEmployees()">
  <i class="fas fa-download"></i> تصدير
</button>
{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
.emp-filters, .stats-cards, .emp-table-wrap, #importSection {
  background:#fff;border:1px solid #e2e8f0;border-radius:16px;
  padding:1rem;box-shadow:0 4px 14px rgba(0,0,0,.06);margin-bottom:1.2rem;
}
.emp-filters .filter-group{display:flex;flex-wrap:wrap;gap:.7rem;align-items:center}
.emp-filters input, .emp-filters select{
  border:2px solid #e2e8f0;font-size:.8rem;padding:.45rem .6rem;border-radius:8px;
}
.stats-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(190px,1fr));gap:1rem}
.stat-card{display:flex;align-items:center;gap:.8rem;padding:.9rem .8rem;border:1px solid #e2e8f0;border-radius:16px;background:#fff;box-shadow:0 4px 14px rgba(0,0,0,.05);transition:.35s}
.stat-card:hover{transform:translateY(-4px);box-shadow:0 12px 30px rgba(0,0,0,.12)}
.stat-icon{width:50px;height:50px;border-radius:14px;background:linear-gradient(135deg,#2563eb,#1d4ed8);display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.25rem}
.stat-info h3{margin:0;font-size:1.3rem;font-weight:700;color:#1e293b}
.stat-info p{margin:0;font-size:.65rem;font-weight:600;letter-spacing:.5px;color:#64748b}
.emp-table-wrap table{width:100%}
.emp-table-wrap th{font-size:.65rem;letter-spacing:.5px;background:#f1f5f9}
.emp-table-wrap td{font-size:.68rem;vertical-align:middle}
.vacation-balance{padding:.20rem .55rem;border-radius:20px;font-weight:600;font-size:.58rem;background:#d1fae5;color:#065f46}
.vacation-balance.low-balance{background:#fee2e2;color:#991b1b}
.status{padding:.25rem .6rem;border-radius:16px;font-size:.58rem;font-weight:600}
.status-active{background:#d1fae5;color:#065f46}
.action-buttons .btn{padding:.25rem .4rem;font-size:.55rem}
#importSection ul{margin:.4rem 0 .6rem;padding-inline-start:1.2rem;font-size:.65rem}
.import-hidden{display:none}
.modal-custom{background:#fff;border-radius:18px;max-width:720px;margin:3rem auto;padding:0;box-shadow:0 16px 48px rgba(0,0,0,.25);overflow:hidden}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:1060;display:none;overflow-y:auto;padding:1rem}
.modal-overlay.show{display:block}
.modal-header-custom{display:flex;justify-content:space-between;align-items:center;padding:.9rem 1.1rem;border-bottom:1px solid #e2e8f0;background:#f8fafc}
.modal-header-custom h6{margin:0;font-size:.9rem;font-weight:700}
.modal-body-custom{padding:1rem 1.1rem}
.modal-footer-custom{padding:.8rem 1.1rem;border-top:1px solid #e2e8f0;display:flex;justify-content:flex-end;gap:.6rem;background:#f8fafc}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:.8rem;margin-bottom:.8rem}
.form-row.single{grid-template-columns:1fr}
.form-row label{font-size:.6rem;font-weight:600;letter-spacing:.4px;color:#475569}
.form-row input, .form-row select{
  border:2px solid #e2e8f0;border-radius:10px;padding:.45rem .55rem;font-size:.7rem;
}
.workdays-box{border:1px solid #e2e8f0;border-radius:12px;padding:.6rem;margin-top:.3rem;background:#f8fafc}
.workdays-box h6{font-size:.65rem;font-weight:700;margin-bottom:.4rem}
.workdays-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:.35rem}
.workdays-grid .slot{background:#fff;border:1px solid #dbe2ea;border-radius:8px;padding:.35rem .4rem;display:flex;flex-direction:column;gap:.2rem}
.workdays-grid label{font-size:.6rem;margin:0;font-weight:600}
.period-select{width:100%;padding:.25rem .3rem;font-size:.55rem;border:1px solid #d1d9e2;border-radius:6px}
.special-flags{display:flex;gap:1rem;margin-top:.5rem;font-size:.65rem}
.special-flags label{font-weight:600}
.details-grid{display:grid;grid-template-columns:1fr 1fr;gap:.5rem;font-size:.65rem;margin-bottom:.7rem}
.details-grid .cell{background:#f1f5f9;padding:.4rem .5rem;border-radius:8px}
.sub-table{font-size:.58rem}
.sub-table th{background:#f8fafc;font-weight:600}
@media (max-width:768px){
  .form-row{grid-template-columns:1fr}
  .stats-cards{grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
  .emp-filters .filter-group{flex-direction:column;align-items:stretch}
  .details-grid{grid-template-columns:1fr}
}
</style>
{% endblock %}

{% block content %}
<div id="flashBox"></div>

<div class="emp-filters">
  <div class="filter-group">
    <input type="text" id="searchInput" placeholder="بحث بالاسم أو الرقم...">
    <select id="departmentFilter">
      <option value="">جميع الأقسام</option>
      {% for dept in departments %}
      <option value="{{ dept.id }}">{{ dept.name }}</option>
      {% endfor %}
    </select>
    <select id="statusFilter">
      <option value="">جميع الحالات</option>
      <option value="active">نشط</option>
      <option value="inactive">غير نشط</option>
    </select>
  </div>
</div>

<div class="stats-cards">
  <div class="stat-card">
    <div class="stat-icon"><i class="fas fa-users"></i></div>
    <div class="stat-info">
      <h3 id="totalEmployeesStat">{{ employees|length }}</h3>
      <p>إجمالي الموظفين</p>
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-icon"><i class="fas fa-building"></i></div>
    <div class="stat-info">
      <h3>{{ departments|length }}</h3>
      <p>عدد الأقسام</p>
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-icon"><i class="fas fa-calendar-check"></i></div>
    <div class="stat-info">
      <h3>{{ on_vacation_count }}</h3>
      <p>في إجازة الآن</p>
    </div>
  </div>
</div>

<!-- استيراد -->
<div id="importSection" class="import-hidden">
  <h6 class="mb-2"><i class="fas fa-file-import"></i> استيراد الموظفين (ترتيب الأعمدة كما في الصورة: A→J)</h6>
  <ol class="small mb-2" style="padding-right:1.1rem;">
    <li>serial_number</li>
    <li>name</li>
    <li>national_id</li>
    <li>hiring_date (yyyy-mm-dd)</li>
    <li>job_grade (الدرجة X)</li>
    <li>bonus</li>
    <li>grade_date (yyyy-mm-dd)</li>
    <li>vacation_balance</li>
    <li>department (اسم أو رقم)</li>
    <li>work_days (مثال 0:M,1:F أو الندب / تفرغ)</li>
  </ol>
  <form action="{{ url_for('employees_console_bp.employees_import') }}" method="post" enctype="multipart/form-data" class="row g-2">
    <div class="col-md-4">
      <input type="file" name="file" accept=".xlsx,.xls" class="form-control form-control-sm" required>
    </div>
    <div class="col-md-8 d-flex gap-2">
      <button class="btn btn-primary btn-sm"><i class="fas fa-upload"></i> رفع واستيراد</button>
      <button type="button" class="btn btn-secondary btn-sm" onclick="toggleImportSection()">إغلاق</button>
    </div>
  </form>
  <hr class="my-2">
</div>

<div class="emp-table-wrap">
  <div class="table-responsive">
    <table class="table table-sm table-bordered" id="employeesTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>الرقم الآلي</th>
          <th>الاسم</th>
          <th>الرقم الوطني</th>
          <th>القسم</th>
          <th>الدرجة</th>
          <th>تاريخ التعيين</th>
          <th>الدرجة تاريخ</th>
          <th>العلاوة</th>
          <th>رصيد</th>
          <th>الحالة</th>
          <th>إجراءات</th>
        </tr>
      </thead>
      <tbody id="empBody">
        {% for e in employees %}
        <tr data-id="{{ e.id }}" data-dept="{{ e.department_id }}" data-status="{{ e.status }}">
          <td>{{ e.id }}</td>
          <td>{{ e.serial_number or '-' }}</td>
          <td>{{ e.name }}</td>
          <td>{{ e.national_id or '-' }}</td>
          <td>{{ e.dept_name or 'غير محدد' }}</td>
          <td>{{ e.job_grade or '-' }}</td>
          <td>{{ e.hiring_date or '-' }}</td>
          <td>{{ e.grade_date or '-' }}</td>
          <td>{{ e.bonus or 0 }}</td>
          <td><span class="vacation-balance {% if e.vacation_balance < 10 %}low-balance{% endif %}">{{ e.vacation_balance }}</span></td>
          <td><span class="status status-{{ e.status }}">{{ 'نشط' if e.status=='active' else e.status }}</span></td>
          <td class="action-buttons d-flex flex-wrap gap-1">
            <button class="btn btn-danger" onclick="deleteEmployee({{ e.id }})" title="حذف"><i class="fas fa-trash"></i></button>
            <button class="btn btn-warning" onclick="viewEmployee({{ e.id }})" title="عرض"><i class="fas fa-eye"></i></button>
            <button class="btn btn-info" onclick="editEmployee({{ e.id }})" title="تعديل"><i class="fas fa-edit"></i></button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modal إضافة/تعديل -->
<div id="employeeModal" class="modal-overlay">
  <div class="modal-custom">
    <div class="modal-header-custom">
      <h6 id="modalTitle" class="m-0">إضافة موظف جديد</h6>
      <button class="btn btn-sm btn-outline-secondary" onclick="closeEmployeeModal()">×</button>
    </div>
    <form id="employeeForm">
      <div class="modal-body-custom">
        <div class="form-row">
          <div>
            <label>الرقم الآلي</label>
            <input type="text" name="serial_number" required>
          </div>
          <div>
            <label>الاسم الكامل</label>
            <input type="text" name="name" required>
          </div>
        </div>
        <div class="form-row">
          <div>
            <label>الرقم الوطني</label>
            <input type="text" name="national_id" required>
          </div>
          <div>
            <label>القسم (ID أو اسم)</label>
            <input type="text" name="department_id" placeholder="مثال: 3 أو الإدارة">
          </div>
        </div>
        <div class="form-row">
          <div>
            <label>الدرجة الوظيفية</label>
            <select name="job_grade">
              <option value="">اختر</option>
              {% for i in range(1,15) %}
              <option value="الدرجة {{i}}">الدرجة {{i}}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label>تاريخ التعيين</label>
            <input type="date" name="hiring_date">
          </div>
        </div>
        <div class="form-row">
          <div>
            <label>تاريخ الدرجة</label>
            <input type="date" name="grade_date">
          </div>
          <div>
            <label>العلاوة</label>
            <input type="number" name="bonus" value="0" min="0">
          </div>
        </div>
        <div class="form-row">
          <div>
            <label>رصيد الإجازات</label>
            <input type="number" name="vacation_balance" value="30" min="0">
          </div>
          <div>
            <label>الحالة</label>
            <select name="status">
              <option value="active" selected>نشط</option>
              <option value="inactive">غير نشط</option>
            </select>
          </div>
        </div>

        <!-- أيام العمل -->
        <div class="workdays-box">
          <h6>أيام العمل والفترات</h6>
          <div class="workdays-grid" id="workdaysGrid"></div>
          <div class="special-flags">
            <div>
              <input type="checkbox" id="secondmentFlag">
              <label for="secondmentFlag">الندب</label>
            </div>
            <div>
              <input type="checkbox" id="dedicationFlag">
              <label for="dedicationFlag">تفرغ</label>
            </div>
          </div>
          <div class="small text-muted mt-1">في حال اختيار (الندب) أو (تفرغ) يتم تعطيل اختيار الأيام.</div>
        </div>

      </div>
      <div class="modal-footer-custom">
        <button type="button" class="btn btn-secondary btn-sm" onclick="closeEmployeeModal()">إلغاء</button>
        <button type="submit" class="btn btn-primary btn-sm">حفظ</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal تفاصيل -->
<div id="employeeDetailsModal" class="modal-overlay">
  <div class="modal-custom">
    <div class="modal-header-custom">
      <h6 class="m-0">تفاصيل الموظف</h6>
      <button class="btn btn-sm btn-outline-secondary" onclick="closeDetailsModal()">×</button>
    </div>
    <div class="modal-body-custom" id="detailsBody">
      جاري التحميل...
    </div>
    <div class="modal-footer-custom">
      <button class="btn btn-secondary btn-sm" onclick="closeDetailsModal()">إغلاق</button>
    </div>
  </div>
</div>

<!-- Modal الأقسام -->
<div id="departmentsModal" class="modal-overlay">
  <div class="modal-custom" style="max-width:600px">
    <div class="modal-header-custom">
      <h6 class="m-0">إدارة الأقسام</h6>
      <button class="btn btn-sm btn-outline-secondary" onclick="closeDepartmentsModal()">×</button>
    </div>
    <div class="modal-body-custom">
      <div class="mb-2 d-flex gap-2">
        <input id="newDeptName" class="form-control form-control-sm" placeholder="اسم قسم جديد">
        <button class="btn btn-primary btn-sm" onclick="addDepartment()">إضافة</button>
      </div>
      <div class="table-responsive">
        <table class="table table-sm table-bordered mb-0" id="deptTable">
          <thead class="table-light">
            <tr><th style="width:55px">#</th><th>الاسم</th><th style="width:240px">إجراءات</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <p id="noDeptMsg" class="text-center text-muted py-2 d-none mb-0">لا توجد أقسام</p>
      </div>
    </div>
    <div class="modal-footer-custom">
      <button class="btn btn-secondary btn-sm" onclick="closeDepartmentsModal()">إغلاق</button>
    </div>
  </div>
</div>

<!-- Modal تعيين رئيس قسم -->
<div id="assignHeadModal" class="modal-overlay">
  <div class="modal-custom" style="max-width:520px">
    <div class="modal-header-custom">
      <h6 class="m-0">تعيين رئيس قسم</h6>
      <button class="btn btn-sm btn-outline-secondary" onclick="closeAssignHeadModal()">×</button>
    </div>
    <form id="assignHeadForm">
      <div class="modal-body-custom">
        <input type="hidden" id="ahDeptId">
        <div class="mb-2 small text-muted">القسم: <strong id="ahDeptName">—</strong></div>
        <div class="form-row single">
          <div>
            <label>اختر الموظف</label>
            <select id="ahEmployee" class="form-select form-select-sm" required>
              <option value="">جاري التحميل...</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div>
            <label>اسم المستخدم</label>
            <input id="ahUsername" class="form-control form-control-sm" placeholder="username" required>
          </div>
          <div>
            <label>كلمة المرور</label>
            <input id="ahPassword" type="password" class="form-control form-control-sm" placeholder="password" required>
          </div>
        </div>
        <div class="small text-muted">سيتم إنشاء مستخدم بدور رئيس قسم وربطه بهذا القسم.</div>
      </div>
      <div class="modal-footer-custom">
        <button type="button" class="btn btn-secondary btn-sm" onclick="closeAssignHeadModal()">إلغاء</button>
        <button class="btn btn-success btn-sm" type="submit">حفظ</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js" defer></script>
<script>
/* ----------------- Utilities ----------------- */
function flash(msg,type='info',timeout=3000){
  const box=document.getElementById('flashBox');
  const el=document.createElement('div');
  el.className=`alert alert-${type} py-2 mb-2`;
  el.textContent=msg;
  box.appendChild(el);
  setTimeout(()=>el.remove(), timeout);
}
function serializeWorkDays(){
  const specialSecond=secondmentFlag.checked;
  const specialDed=dedicationFlag.checked;
  if(specialSecond) return 'الندب';
  if(specialDed) return 'تفرغ';
  const sel=[];
  document.querySelectorAll('.wd-day').forEach(slot=>{
    const cb=slot.querySelector('input[type="checkbox"]');
    const day=cb.dataset.day;
    if(cb.checked){
      const period=slot.querySelector('select').value; // M/E/F
      sel.push(`${day}:${period}`);
    }
  });
  return sel.join(',');
}
function fillWorkDays(raw){
  secondmentFlag.checked=false;
  dedicationFlag.checked=false;
  document.querySelectorAll('.wd-day input[type="checkbox"]').forEach(c=>{c.checked=false;c.disabled=false;});
  document.querySelectorAll('.wd-day select').forEach(s=>{s.disabled=false;s.value='F';});
  if(!raw) return;
  raw=raw.trim();
  if(raw==='الندب'){ secondmentFlag.checked=true; toggleSpecialFlags(); return; }
  if(raw==='تفرغ'){ dedicationFlag.checked=true; toggleSpecialFlags(); return; }
  raw.split(',').forEach(p=>{
    if(!p) return;
    const [d,per]=p.split(':');
    const cb=document.querySelector(`.wd-day input[data-day="${d}"]`);
    const sel=document.querySelector(`.wd-day select[data-day="${d}"]`);
    if(cb){ cb.checked=true; }
    if(sel && per){ sel.value=per; }
  });
}

/* ----------------- Build Work Days UI ----------------- */
const WD_DAYS=[
  {code:'0',label:'السبت'},
  {code:'1',label:'الأحد'},
  {code:'2',label:'الإثنين'},
  {code:'3',label:'الثلاثاء'},
  {code:'4',label:'الأربعاء'},
  {code:'5',label:'الخميس'},
  {code:'6',label:'الجمعة'},
];
function buildWorkDaysGrid(){
  const grid=document.getElementById('workdaysGrid');
  grid.innerHTML='';
  WD_DAYS.forEach(d=>{
    const div=document.createElement('div');
    div.className='slot wd-day';
    div.innerHTML=`
      <label><input type="checkbox" data-day="${d.code}"> ${d.label}</label>
      <select class="period-select" data-day="${d.code}">
        <option value="M">صباحية</option>
        <option value="E">مسائية</option>
        <option value="F" selected>كامل اليوم</option>
      </select>
    `;
    grid.appendChild(div);
  });
}
function toggleSpecialFlags(){
  const any=secondmentFlag.checked||dedicationFlag.checked;
  document.querySelectorAll('.wd-day input[type="checkbox"], .wd-day select').forEach(el=>{
    el.disabled=any;
  });
  if(any){
    document.querySelectorAll('.wd-day input[type="checkbox"]').forEach(cb=>cb.checked=false);
  }
}

/* ----------------- Modal control ----------------- */
function showAddEmployeeModal(){
  employeeForm.reset();
  document.getElementById('modalTitle').textContent='إضافة موظف جديد';
  employeeForm.dataset.mode='add';
  employeeForm.dataset.employeeId='';
  buildWorkDaysGrid();
  fillWorkDays('');
  employeeModal.classList.add('show');
}
function closeEmployeeModal(){
  employeeModal.classList.remove('show');
}
function toggleImportSection(){
  importSection.classList.toggle('import-hidden');
}

/* ----------------- CRUD Actions ----------------- */
async function deleteEmployee(id){
  if(!confirm('تأكيد حذف الموظف؟')) return;
  try{
    const r=await fetch(`/manager/employees/delete/${id}`,{method:'DELETE'});
    const js=await r.json();
    if(!r.ok) throw new Error(js.error||'فشل الحذف');
    flash('تم الحذف','success');
    const tr=document.querySelector(`#employeesTable tbody tr[data-id="${id}"]`);
    if(tr) tr.remove();
  }catch(e){
    flash(e.message,'danger',6000);
  }
}
function editEmployee(id){
  const tr=document.querySelector(`#employeesTable tbody tr[data-id="${id}"]`);
  if(!tr){ flash('الموظف غير موجود بالجدول','danger'); return; }
  showAddEmployeeModal();
  document.getElementById('modalTitle').textContent='تعديل موظف';
  employeeForm.dataset.mode='edit';
  employeeForm.dataset.employeeId=id;
  employeeForm.serial_number.value=tr.children[1].textContent.trim();
  employeeForm.name.value=tr.children[2].textContent.trim();
  employeeForm.national_id.value=tr.children[3].textContent.trim();
  employeeForm.department_id.value=tr.children[4].textContent.trim();
  employeeForm.job_grade.value=tr.children[5].textContent.trim();
  employeeForm.hiring_date.value=tr.children[6].textContent.trim()!=='-'?tr.children[6].textContent.trim():'';
  employeeForm.grade_date.value=tr.children[7].textContent.trim()!=='-'?tr.children[7].textContent.trim():'';
  employeeForm.bonus.value=tr.children[8].textContent.trim();
  employeeForm.vacation_balance.value=tr.children[9].textContent.trim();
  employeeForm.status.value=tr.dataset.status||'active';
  fetch(`/manager/employees/${id}/details`).then(r=>r.json()).then(js=>{
    if(js.success){ buildWorkDaysGrid(); fillWorkDays(js.employee.work_days_raw); toggleSpecialFlags(); }
  }).catch(()=>{});
}

async function viewEmployee(id){
  employeeDetailsModal.classList.add('show');
  detailsBody.innerHTML='جاري التحميل...';
  try{
    const r=await fetch(`/manager/employees/${id}/details`);
    const js=await r.json();
    if(!r.ok || !js.success) throw new Error(js.error||'فشل');
    const e=js.employee;
    let vacHtml='<table class="table table-bordered sub-table mb-2"><thead><tr><th>ID</th><th>النوع</th><th>البداية</th><th>النهاية</th><th>أيام</th><th>الحالة</th></tr></thead><tbody>';
    if(js.vacations.length){
      js.vacations.forEach(v=>{
        vacHtml+=`<tr><td>${v.id}</td><td>${v.type_code}</td><td>${v.start_date}</td><td>${v.end_date}</td><td>${v.requested_days}</td><td>${v.status}</td></tr>`;
      });
    }else{
      vacHtml+='<tr><td colspan="6" class="text-center text-muted">لا يوجد</td></tr>';
    }
    vacHtml+='</tbody></table>';

    let absHtml='<table class="table table-bordered sub-table mb-0"><thead><tr><th>ID</th><th>النوع</th><th>البداية</th><th>النهاية</th><th>مدة</th></tr></thead><tbody>';
    if(js.absences.length){
      js.absences.forEach(a=>{
        absHtml+=`<tr><td>${a.id}</td><td>${a.type}</td><td>${a.start_date}</td><td>${a.end_date}</td><td>${a.duration||''}</td></tr>`;
      });
    }else{
      absHtml+='<tr><td colspan="5" class="text-center text-muted">لا يوجد</td></tr>';
    }
    absHtml+='</tbody></table>';

    detailsBody.innerHTML=`
      <div class="details-grid">
        <div class="cell"><strong>الاسم:</strong> ${e.name}</div>
        <div class="cell"><strong>الرقم الوطني:</strong> ${e.national_id||'-'}</div>
        <div class="cell"><strong>الرقم الآلي:</strong> ${e.serial_number||'-'}</div>
        <div class="cell"><strong>القسم:</strong> ${e.dept_name||'-'}</div>
        <div class="cell"><strong>الدرجة:</strong> ${e.job_grade||'-'}</div>
        <div class="cell"><strong>تعيين:</strong> ${e.hiring_date||'-'}</div>
        <div class="cell"><strong>تاريخ الدرجة:</strong> ${e.grade_date||'-'}</div>
        <div class="cell"><strong>رصيد إجازات:</strong> ${e.vacation_balance}</div>
        <div class="cell"><strong>الحالة:</strong> ${e.status}</div>
        <div class="cell" style="grid-column:1 / -1;"><strong>أيام العمل:</strong> ${e.work_days_human||'-'}</div>
      </div>
      <h6 class="fw-bold small mb-1">آخر الإجازات</h6>
      ${vacHtml}
      <h6 class="fw-bold small mt-3 mb-1">آخر الغيابات</h6>
      ${absHtml}
    `;
  }catch(e){
    detailsBody.innerHTML='<div class="alert alert-danger py-2">'+e.message+'</div>';
  }
}
function closeDetailsModal(){ employeeDetailsModal.classList.remove('show'); }

/* ----------------- Export ----------------- */
function exportEmployees(){
  window.open('/manager/employees/export','_blank');
}

/* ----------------- Filtering ----------------- */
function filterEmployees(){
  const txt=searchInput.value.trim().toLowerCase();
  const dept=departmentFilter.value;
  const st=statusFilter.value;
  let total=0;
  document.querySelectorAll('#employeesTable tbody tr').forEach(tr=>{
    const name=tr.children[2].textContent.toLowerCase();
    const serial=tr.children[1].textContent.toLowerCase();
    const deptId=tr.dataset.dept;
    const status=tr.dataset.status;
    const matchTxt= !txt || name.includes(txt) || serial.includes(txt);
    const matchDept= !dept || deptId===dept;
    const matchStatus= !st || status===st;
    const show = matchTxt && matchDept && matchStatus;
    tr.style.display= show ? '' : 'none';
    if(show) total++;
  });
  totalEmployeesStat.textContent=total;
}
['searchInput','departmentFilter','statusFilter'].forEach(id=>{
  document.getElementById(id).addEventListener('input',filterEmployees);
  document.getElementById(id).addEventListener('change',filterEmployees);
});

/* ----------------- Submit Form (Add/Edit) ----------------- */
employeeForm.addEventListener('submit',async e=>{
  e.preventDefault();
  const mode=employeeForm.dataset.mode||'add';
  const payload={
    serial_number:employeeForm.serial_number.value.trim()||null,
    name:employeeForm.name.value.trim(),
    national_id:employeeForm.national_id.value.trim(),
    department:employeeForm.department_id.value.trim()||null,
    job_grade:employeeForm.job_grade.value||null,
    hiring_date:employeeForm.hiring_date.value||null,
    grade_date:employeeForm.grade_date.value||null,
    bonus:employeeForm.bonus.value||0,
    vacation_balance:employeeForm.vacation_balance.value||30,
    status:employeeForm.status.value||'active',
    work_days:serializeWorkDays()
  };
  if(!payload.name){flash('الاسم مطلوب','danger');return;}
  const url = mode==='edit'
    ? `/manager/employees/update/${employeeForm.dataset.employeeId}`
    : '/manager/employees/add';
  try{
    const r=await fetch(url,{
      method: mode==='edit'?'PUT':'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });
    const js=await r.json();
    if(!r.ok || !js.success) throw new Error(js.error||'فشل الحفظ');
    flash(js.message||'تم الحفظ','success');
    closeEmployeeModal();
    setTimeout(()=>location.reload(),600);
  }catch(err){
    flash(err.message,'danger',6000);
  }
});

/* ----------------- Special Flags Toggle ----------------- */
function buildWorkDaysGrid(){ /* already defined above */ }
function toggleSpecialFlags(){ /* already defined above */ }
secondmentFlag.addEventListener('change',toggleSpecialFlags);
dedicationFlag.addEventListener('change',toggleSpecialFlags);

/* ================== الأقسام ================== */
async function loadDepartments(){
  try{
    const r=await fetch('/manager/departments/list');
    const js=await r.json();
    const tb=document.querySelector('#deptTable tbody');
    tb.innerHTML='';
    if(!js.success || !js.items.length){
      document.getElementById('noDeptMsg').classList.remove('d-none');
      return;
    }
    document.getElementById('noDeptMsg').classList.add('d-none');
    js.items.forEach(d=>{
      const safeName = (d.name||'').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${d.id}</td>
        <td><span class="dept-name" data-id="${d.id}">${safeName}</span></td>
        <td class="d-flex gap-1 flex-wrap">
          <button class="btn btn-sm btn-success" onclick="openAssignHeadModal(${d.id}, '${safeName}')">تعيين رئيس</button>
          <button class="btn btn-sm btn-warning" onclick="renameDepartment(${d.id}, '${safeName}')">إعادة تسمية</button>
          <button class="btn btn-sm btn-danger" onclick="deleteDepartment(${d.id})">حذف</button>
        </td>
      `;
      tb.appendChild(tr);
    });
  }catch(e){
    flash('فشل تحميل الأقسام: '+e.message,'danger',6000);
  }
}
function openDepartmentsModal(){
  loadDepartments();
  departmentsModal.classList.add('show');
}
function closeDepartmentsModal(){
  departmentsModal.classList.remove('show');
}
async function addDepartment(){
  const name=newDeptName.value.trim();
  if(!name){ flash('أدخل اسم القسم','danger'); return; }
  try{
    const r=await fetch('/manager/departments/add',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({name})
    });
    const js=await r.json();
    if(!r.ok || !js.success) throw new Error(js.error||'خطأ');
    newDeptName.value='';
    loadDepartments();
    flash('تمت الإضافة','success');
  }catch(e){ flash(e.message,'danger',6000); }
}
async function renameDepartment(id, oldName){
  const nn=prompt('اسم جديد للقسم:', oldName||'');
  if(!nn || !nn.trim()) return;
  try{
    const r=await fetch(`/manager/departments/${id}`,{
      method:'PUT',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({name:nn.trim()})
    });
    const js=await r.json();
    if(!r.ok || !js.success) throw new Error(js.error||'خطأ');
    loadDepartments();
    flash('تم التعديل','success');
  }catch(e){ flash(e.message,'danger',6000); }
}
async function deleteDepartment(id){
  if(!confirm('تأكيد حذف القسم؟ (سيرفض إن كان مرتبطاً بموظفين)')) return;
  try{
    const r=await fetch(`/manager/departments/${id}`,{method:'DELETE'});
    const js=await r.json();
    if(!r.ok || !js.success) throw new Error(js.error||'لا يمكن الحذف');
    loadDepartments();
    flash('تم الحذف','success');
  }catch(e){ flash(e.message,'danger',6000); }
}

/* ------- تعيين رئيس قسم ------- */
function openAssignHeadModal(deptId, deptName){
  ahDeptId.value = String(deptId);
  ahDeptName.textContent = deptName || ('#'+deptId);
  ahEmployee.innerHTML = '<option value="">جاري التحميل...</option>';
  ahUsername.value = '';
  ahPassword.value = '';
  // جلب موظفي القسم من API الجديدة
  fetch(`/api/v1/manager/employees?department_id=${encodeURIComponent(deptId)}&limit=500`, {credentials:'include'})
    .then(r=>r.json().then(js=>({ok:r.ok,js})))
    .then(({ok,js})=>{
      if(!ok || !Array.isArray(js)) throw new Error(js.error||'فشل تحميل الموظفين');
      ahEmployee.innerHTML = '<option value="">اختر موظفاً...</option>';
      js.forEach(e=>{
        const opt=document.createElement('option');
        opt.value=e.id;
        opt.textContent = `${e.name} (ID:${e.id})`;
        ahEmployee.appendChild(opt);
      });
    }).catch(err=>{
      ahEmployee.innerHTML = '<option value="">فشل التحميل</option>';
      flash(err.message, 'danger', 6000);
    });
  assignHeadModal.classList.add('show');
}
function closeAssignHeadModal(){
  assignHeadModal.classList.remove('show');
}
assignHeadForm.addEventListener('submit', e=>{
  e.preventDefault();
  const deptId = ahDeptId.value;
  const employee_id = Number(ahEmployee.value);
  const username = ahUsername.value.trim();
  const password = ahPassword.value.trim();
  if(!employee_id){ flash('اختر الموظف','danger'); return; }
  if(!username || !password){ flash('أدخل اسم المستخدم وكلمة المرور','danger'); return; }
  fetch(`/api/v1/manager/departments/${deptId}/assign-head`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    credentials:'include',
    body: JSON.stringify({ employee_id, username, password })
  }).then(r=>r.json().then(js=>({ok:r.ok,js})))
    .then(({ok,js})=>{
      if(!ok) throw new Error(js.error||'فشل التعيين');
      flash('تم تعيين رئيس القسم','success');
      closeAssignHeadModal();
      loadDepartments();
    }).catch(err=>flash(err.message,'danger',6000));
});

/* ----------------- Init ----------------- */
document.addEventListener('DOMContentLoaded',()=>{
  buildWorkDaysGrid();
  filterEmployees();
});

/* إغلاق المودالات عند الضغط خارج */
window.addEventListener('click',e=>{
  if(e.target===employeeModal) closeEmployeeModal();
  if(e.target===employeeDetailsModal) closeDetailsModal();
  if(e.target===departmentsModal) closeDepartmentsModal();
  if(e.target===assignHeadModal) closeAssignHeadModal();
});
</script>
{% endblock %}